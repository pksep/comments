name: Remote Dispath Deploy

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-22.04

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Executing ssh deploy command
              uses: appleboy/ssh-action@v1.0.3
              with:
                host: ${{ secrets.DEV_SSH_HOST }}
                username: ${{ secrets.DEV_SSH_USER }}
                key: ${{ secrets.DEV_SSH_KEY }}
                port: ${{ secrets.DEV_SSH_PORT }}
                script: |
                    cd ~/erp_k8s/erp_k8s && \
                    export KUBECONFIG=/etc/rancher/k3s/k3s.yaml && \
                    
                    if env "APP=comments" "BRANCH=${{ github.ref_name }}" "MODE=prod" bun utils.ts switch-branch; then
                      STATUS="Success"
                    else
                      STATUS="Failed"
                    fi

                    END_TIME=$(date +'%H:%M:%S')

                    curl -X POST http://localhost:30012/notify \
                      -H "Content-Type: application/json" \
                      -d "{
                        \"service\": \"comments\",
                        \"status\": \"$STATUS\",
                        \"branch\": \"${{ github.ref_name }}\",
                        \"time\": \"$END_TIME\",
                        \"env\": \"DEV\",
                        \"actionUrl\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                      }"